<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>NodeArt</title>
    <link rel="stylesheet" type="text/css" href="/semantic/dist/semantic.min.css">
    <script src="/semantic/bower_components/jquery/dist/jquery.min.js"></script>
    <script src="/semantic/dist/semantic.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.6.1/lodash.min.js" type="text/javascript"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyB0mU4ILaXvry-r7nQ3xnziVmCM_AkbCYM"></script>
</head>

<body>
<div class="ui container">
    <h1 class="ui header">
        <span class="ui image"><i class="feed icon"></i></span>
        <div class="content">
            Twitter Scrapper
        </div>
    </h1>
    <h2 class="ui dividing header">Query some Twitter data</h2>
    <form class="ui form" id="myForm" onsubmit="return false;">
        <input type="radio" name="Or" value="No"> AND
        <br>
        <input type="radio" name="Or" value="YES"> OR
        <br>
        <div class="field">
            <label> Enter the @ of a team you would like to search for:</label>
            <input type="text" name="teamName" placeholder="@ManUtd">
            <br>
            <br>
            <div class="ui-checkbox">
                <input type="checkbox" name="TeamAut" value="YES">
                <label> Author</label>
            </div>
            <div class="ui-checkbox">
                <input type="checkbox" name="TeamMen" value="YES">
                <label> Mentions</label>
            </div>
        </div>
        <div class="field">
            <label>Enter the @ of a player you'd like to find:</label>
            <input type="text" name="playerName" placeholder="@WayneRooney">
            <br>
            <br>
            <div class="ui-checkbox">
                <input type="checkbox" name="PlayerAut" value="YES">
                <label> Author</label>
            </div>
            <div class="ui-checkbox">
                <input type="checkbox" name="PlayerMen" value="YES">
                <label> Mentions</label>
            </div>
        </div>
        <div class="field">
            <label>Enter any related hashtags:</label>
            <input type="text" name="hashtag" placeholder="#Research">
        </div>
        <div class="field">
            <label>Enter any specific keywords:</label>
            <input type="text" name="keywords" placeholder=" ">
        </div>
        <button class="ui button" id="sendButton">Query Data</button>
             <div class="ui error message"><ul class="list"><li></li>
                 <li></li></ul>
             </div>
            <br>
            <br>
    </form>
    <br>
    <div class="ui fluid card">
        <div class="content">
            <div class="header">Tweets Timeline</div>
            <span id="db_info"> </span>
            <div id="counts">
                <div id="users"></div>

            </div>
            <div id="count_result">


            </div>
            <ul id="result">

            </ul>
        </div>
        <!-- for now lets make it simple -->
    </div>
    <div class="ui fluid card">
        <div class="content">
            <div class="header">Tweet locations</div>
            <div id="map-canvas" style="width:100%;height:300pt;align:center;"></div>
        </div>
    </div>

    <script>
        function sendAjaxQuery(url, data) {
            $('#result').html('');
            var $bodyAndHtml = $("body,html");
            function scrollToContent () {
                $bodyAndHtml.animate({ scrollTop: $(".content").eq(1).offset().top })
            }
            $.ajax({
                type: 'POST',
                url: 'postFile.html',
                dataType: 'json',
                data: data,
                success: function (tweets) {
                    scrollToContent();
                    console.log(tweets);
                    console.log(tweets[0]);

                    // maps
                    var latCoordinates = [];
                    var longCoordinates = [];
                    var tweetHTMLArray = [];
                    var tweets_A = [];

                    //words and users
                    var wordCounts = {};
                    var userCounts = {};
                    var mostUsedWords = [];
                    var mostActiveUsers= [];
                    var finalArray = [];

                    var flaggedWords = ['a', 'to', 'o', 't.co', 't', 'co', 'or','RT', 'https','so','for', 'the', 'and',
                                         'this', 'of', 'i', 'I' ,'1','2', '3','4','5','6','7','8','9','0'];

                    if(tweets[1].count){
                        var counts_db = '<div>' + '<br>' + 'Results Returned by the  Twitter API: ' +
                                        tweets[1].added + '&nbsp;' +'Tweets' + '<br>' +
                                        'New tweets stored into the database: ' + tweets[1].added + '<br>' +
                                        'Results returned by the database: ' +  tweets[1].count+ ' ' + ' Tweets' +
                                        '<br>' +
                                        '</div>';
                        $('#db_info').append(counts_db);
                    } else {
                        $('#db_info').append(' Results Returned by the  Twitter API: ' + "  " + tweets[1].added);
                    }

                    _.each(tweets[0],function(tweet) {
                        //for word frequencies
                        var initial_words = tweet.text.replace(/[^a-zA-Z0-9 ]/g, "");
                        var words_parse = initial_words.replace(/httpstc|RT/gi, "");
                        var words = words_parse.split(' ');
                        tweets_A.push(tweet.text);

                        // for most active users
                        var user_pattern = (/\B@[a-z0-9_-]+/gi);
                        var user_mentions= tweet.text.match(user_pattern);
                        _.each(user_mentions,function(users){ //console.log(users)
                            if (typeof userCounts[users] === 'undefined') {
                                userCounts[users] = 1;
                            } else {
                                userCounts[users]++
                            }
                        }); //users each
                        var dateReadable, date;
                        dateReadable = new Date(Date.parse(tweet.created_at));
                        date = dateReadable.toDateString();
                        var tweetHtml = "<li>" + " <img class='ui avatar image'  src='" + tweet.user.profile_image_url + " '>" + '<br>'
                                + "  Author: " + tweet.user.name + '&nbsp;' + "<a title='"+ tweet.user.screen_name+
                                "' href='http://twitter.com/"+ tweet.user.screen_name+"'>" +'@'+ tweet.user.screen_name+
                                "</a>"+ '&nbsp;'+ '\t\t' + '&nbsp;' + ' Date: ' + date + '<br> '
                                + "  Tweet: " + tweet.htmlContent +
                                (tweet.retweeted_status ? "<br>  Retweet: " +'@'
                                + tweet.retweeted_status.user.screen_name : "") + "</li>";

                        $('#result').append(tweetHtml); // sends the tweet object to the browser
                        $('#most_frequent_words').remove();

                        // maps
                        tweetHTMLArray.push(tweetHtml);
                        if (tweet.geo != null ) {
                            var tweet_lat = tweet.geo.coordinates[0];
                            var tweet_long = tweet.geo.coordinates[1];
                            longCoordinates.push(tweet_long);
                            latCoordinates.push(tweet_lat);
                        }

                        _.each(words, function (word) {
                            if (flaggedWords.indexOf(word) === -1 && word != '') {
                                if (typeof wordCounts[word] === 'undefined') {
                                    wordCounts[word] = 1;
                                } else {
                                    wordCounts[word]++
                                }
                            }

                        }); // words each

                    }); //Tweet Each

                    for( var word in wordCounts){
                        mostUsedWords.push({word: word, count: wordCounts[word]});
                        // quantity: wordCounts2[word]
                    }

                    for (var user in userCounts){
                        mostActiveUsers.push({user: user, seen: userCounts[user]})
                    }

                    mostActiveUsers.sort(function(a, b) { return b.seen - a.seen;});
                    //$('#users').append("<div id='head_users'>  " + 'Most Frequent Users: ' + " </div>");

                    $('#counts').html('');
                    for(var i= 0; i < 10; i++){
                        if (mostActiveUsers[i]){
                            $('#counts').append('<div id="most_active_users">' +
                                    "<a title='" + mostActiveUsers[i].user + "' href='http://twitter.com/" +
                                    mostActiveUsers[i].user + "'>" + mostActiveUsers[i].user + '&nbsp;' +
                                    "</a>" + 'count =  (' + mostActiveUsers[i].seen + ')');
                        }
                    }


                    mostUsedWords.sort(function(a, b){ return b.count - a.count;});
                    for (var i = 0; i < 20; ++i){
                        if (mostUsedWords[i]) {
                            console.info(mostUsedWords[i]);
//                            $('#counts').append('<div id="most_frequent_words">' + ' ' + "&nbsp;&nbsp;&nbsp;" +
//                             mostUsedWords[i].word  + ':'+ '&nbsp;&nbsp;'+'(' + mostUsedWords[i].count + ") " +
//                             " </div>");
                        }
                    }


                    function activeUserAndKeywords(tweets_A, mostActiveUsers, mostUsedWords){
                        var tweet_counter = 0;  //for counting the tweets user is found in
                        var word_counter = 0; //for counting the words in the tweets

                        _.each(mostActiveUsers, function (user) {
                        var temp_tweetCounter =0;
                        var activeUser = new RegExp(user.user);
                            var temp_info = {
                                author: {
                                    screen_name: user.user,
                                    temp_tweetSeen : user.seen,
                                    words : []
                                }
                            };

                            _.each(tweets_A, function(tweet) {
                                if (activeUser.test(tweet)) {
                                    tweet_counter++;
                                    temp_tweetCounter++;
                                    var temp_wordCount =0;

                                    _.each(mostUsedWords, function(word) {
                                        temp_wordCount++;
                                        if(temp_wordCount >=10)
                                            return;
                                        if (tweet.indexOf(word.word) >= 0){
                                            word_counter++;
                                            temp_info.author.words.push({word : word.word , count : word.count});
                                        } else{
                                            return word.word + " is NOT in tweet.";
                                        }
                                    });
                                } else {
                                    return user.user + " is NOT in tweet.";
                                }
                            });
                            temp_info.author.tweet_counts = temp_tweetCounter;
                            finalArray.push({ user : user.user,
                                              data: temp_info}
                                            );
                        });
                        // console.log("final Array Output: ")
                        // console.log(JSON.stringify(finalArray));
                    }
                    activeUserAndKeywords(tweets_A, mostActiveUsers, mostUsedWords);

                    $('#count_result').append("<div id='head_words'>  " + 'Active Users and Words: ' + " </div>");
                    for (var i = 0; i <10; i++){
                        if (finalArray[i]) {
                          //  console.info(JSON.stringify(finalArray[i]));
                            $('#count_result').append("<div>" +
                                                        " <img class='ui avatar image'  src='https://twitter.com/" +
                                                        finalArray[i].data.author.screen_name + "/profile_image?size=original'>" +
                                                        '&nbsp;' + 'Author: ' + ' ' + "<a title='" + finalArray[i].data.author.screen_name +
                                                        "' href='http://twitter.com/" + finalArray[i].data.author.screen_name + "'>" +
                                                        finalArray[i].data.author.screen_name + "</a>" + '&nbsp;&nbsp;  ' + '  ' + '  ' +
                                                        'Tweets: ' + finalArray[i].data.author.tweet_counts +'&nbsp;' +
                                                        'Most Frequent Words: ' +
                                                        "</div>");
                           var sortedArray = _.sortBy(_.uniqBy(finalArray[i].data.author.words, 'word'), ['count', 'word']);
                            _.eachRight(_.take(sortedArray,10), function (word) {
                               // console.log(word);
                                $('#count_result').append('<div>'+' &nbsp;' + '&nbsp;' + word.word + '&nbsp;' +
                                                            '  ' + '(' + word.count + ')'+" </div>");
                            });
                        }

                    }

                    /* Geo-location map*/
                    function initialize() {
                        var mapCentre = new google.maps.LatLng(latCoordinates[0], longCoordinates[0]);
                        var mapOptions = {
                            zoom: 18,
                            center: mapCentre            };
                        var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                        for (var i=0; i<longCoordinates.length; i++) {
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(latCoordinates[i], longCoordinates[i]),
                                map: map,
                                title: 'Tweet Marker'});
                            var infoWindow = new google.maps.InfoWindow({
                                content: tweetHTMLArray[i]+latCoordinates[i]+', '+longCoordinates[i],
                                maxWidth:200});
                            infoWindow.open(map,marker);
                            google.maps.event.addListener(marker, 'click', function() {
                                infoWindow.open(map, marker);
                            });
                        }
                    }
                    if (latCoordinates.length > 0) {
                        initialize();
                    }
                    else {
                        $('.gm-style').remove();
                        $('#no_locations').remove();
                        $('#map-canvas').append("<h4 id='no_locations'> " +
                                "<br>Your search returned no geo-located tweets :( try again next time :) <\/h4>");
                    }

                },
                error: function(xhr, status, error) {
                    scrollToContent();
                    error = xhr.responseJSON.error;
                    console.error('Error: ' + error);
                    $('#result').append('<li>' + 'Something went wrong sorry: ' + error + '</li>');
                    // error output on web page
                    //alert('error connecting');
                }
            });

        }
        $.fn.serializeObject = function() {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        function sendData() {
            $('#most_active_users').html(''); $('#most_frequent_words').html(''); $('#count_result').html('');
            $('#db_info').html('');
            var form = document.getElementById('myForm');
            sendAjaxQuery('http://localhost:3000/', JSON.stringify($('form').serializeObject()));
        }
        var sendButton = document.getElementById('sendButton');
        sendButton.onclick = sendData;
    </script>
    <script>

        $('.ui.form')
                .form({
                    fields: {
                        teamName: {
                            identifier: 'teamName',
                            rules: [
                                {
                                    type   : 'empty',
                                    prompt : 'Please enter a team or player name.'
                                }
                            ]
                        }

                    }
                });
    </script>
</div>
</body>
</html>