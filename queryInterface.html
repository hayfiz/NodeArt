<!DOCTYPE HTML>
<html>
<head>
    <title>Node Tweets | Home</title>
    <!-- Custom Theme files -->
    <link rel="stylesheet" type="text/css" href="/semantic/dist/semantic.min.css">
    <link rel="stylesheet" href="node_modules/normalize.css/normalize.css">
    <link  rel="stylesheet" type="text/css" href="/css/main.css" media="all"/>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script src="/semantic/dist/semantic.min.js" type="text/javascript"></script>
    <!-- Custom Theme files -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content=" Twitter API web Scrapper, Search form, Tweeter Tweets,  Google Maps API " />
    <!-- Lodash and Google Maps Packages -->
    <script src="https://cdn.jsdelivr.net/lodash/4.6.1/lodash.min.js" type="text/javascript"></script>
    <script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyB0mU4ILaXvry-r7nQ3xnziVmCM_AkbCYM"></script>

</head>

<body>
<!--search start here-->

<div class="ui container">
    <div class="ui blue message">
   <h4 class="cen">Querying the social Web!</h4>
    </div>
    <div class="ui info message">
        <i class="close icon"></i>
        <div class="header">
            <h4 class="ui">Team <b>NodeArtizts</b> welcomes you!.</h4>
        </div>
        <p>Track discussions concerning a football team and it's players!</p>
    </div>


<!--<div class="search">-->
    <form class="ui form" id="myForm" onsubmit="return false;" name="myForm">
        <div class="ui segment">
        <!-- /."" -->
        <div class="fields">
            <div class=" centered fourteen wide field">
                <label>SEARCH TYPE</label>
                <select class="ui dropdown" name="Or">
                    <option value="">ALL</option>
                    <option value="No"> AND</option>
                    <option value="YES">OR</option>
                </select>
            </div>
        </div>
        <div class="fields">
            <div class=" twelve wide field">
                <label>Team Name:</label>
                    <input type="text" name="teamName" name="tm_name" placeholder="What @Team would you like to search for?">
            </div>
        </div>

        <div class="ui horizontal segments">
            <div class="ui segment">
                <div class="two wide field">
                    <div class="inline field">
                        <div class="ui slider checkbox">
                            <input type="checkbox" tabindex="0" class="hidden" name="TeamAut" value="YES">
                            <label>Author</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ui segment">
                <div class="two wide field">
                    <div class="inline field">
                        <div class="ui slider checkbox">
                            <input type="checkbox" tabindex="0" class="hidden" name="TeamMen" value="YES">
                            <label>Mentions</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="fields">
            <div class=" twelve wide field">
                <label>Player Name:</label>
                <input type="text" name="playerName" placeholder="What @player name would you like to search for?">
            </div>
        </div>

        <div class="ui horizontal segments">
            <div class="ui segment">
                <div class="two wide field">
                    <div class="inline field">
                        <div class="ui slider checkbox">
                            <input type="checkbox" tabindex="0" class="hidden" name="PlayerAut" value="YES">
                            <label>Author</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ui segment">
                <div class="two wide field">
                     <div class="inline field">
                            <div class="ui slider checkbox">
                                <input type="checkbox" tabindex="0" class="hidden" name="PlayerMen" value="YES">
                                <label>Mentions</label>
                            </div>
                     </div>
                 </div>
            </div>
        </div>
        <div class="ui equal width form">
            <div class="fields">
                <div class="field">
                    <label>Hashtags:</label>
                    <input type="text" name="hashtag" placeholder="Enter any related hashtags..">
                </div>
                <div class="field">
                    <label>Keywords:</label>
                    <input type="text" name="keywords" placeholder="" >
                </div>
            </div>
        <button class="ui primary large button" id="sendButton" tabindex="0">Search Twitter</button>
        <div class="ui error message">
            <ul class="list"></ul>
        </div>
        </div>
        </div>
    </form>
    <!--search end here-->

     <div class="ui message">
        <div class="header">
            Change Log - Query Infomation
        </div>
        <ul class="list">
            <li>You can now see the most active users.</li>
            <li>You can now see the most active users and the words associated with them.</li>
            <li>You can now see the tweets. </li>
            <li>Profile images have also been added. </li>
            <li>Cache has been implemented with MongoDB.</li>
        </ul>
        <div class="ui info message" id="db_info">
            <i class="small close icon"></i>
        </div>
    </div>

<div class="ui three column divided grid" id="content">
  <div class="row">
    <div class=" five wide column">
      <div class="ui  stacked segment">
       <div id="count_result"></div>
      </div>
    </div>
    <div class="eight wide column">
      <div class="ui stackeds segment">
        <div class="ui blue cen header"><h4>Tweets Timeline</h4></div>
         <div id="result"></div>
      </div>
    </div>
    <div class=" three wide column">
      <div class="ui stacked segment">
        <div class="ui blue cen header"><h4>Most Active Users</h4></div>
         <div class="ui horizontal divider"> - </div>
            <div id="counts">
                <!-- <div id="users"></div> -->
            </div>
      </div>
     </div>
  </div>
</div>

    <div class="ui fluid card">
        <div class="content">
            <div class="ui blue cen header"><h4>Tweet Locations</h4></div>
            <div id="map-canvas">
            </div>
        </div>
    </div>
<a href="#0" class="cd-top">Top</a>
</div>

    <script>
        function sendAjaxQuery(url, data) {
            $('#result').html('');
            var $bodyAndHtml = $("body,html");
            function scrollToContent () {
                $bodyAndHtml.animate({scrollTop: $(window).scrollTop() + 1000 });
            }
            $.ajax({
                type: 'POST',
                url: 'postFile.html',
                dataType: 'json',
                data: data,
                success: function (tweets) {
                scrollToContent();
                    console.log(tweets);
                    console.log(tweets[0]);


                    // maps
                    var latCoordinates = [];
                    var longCoordinates = [];
                    var tweetHTMLArray = [];
                    var tweets_A = [];
                    var info_=[];

                    //words and users
                    var wordCounts = {};
                    var userCounts = {};
                    var mostUsedWords = [];
                    var mostActiveUsers= [];

                    var flaggedWords = ['a', 'A', 'as','it','on','in', 'to', 'o', 't.co', 't', 'co', 'or','RT', 'https','so','for', 'the', 'and', 'this', 'of', 'i', 'I' ,'1','2',
                    '3','4','5','6','7','8','9','0'];

                    if(tweets[1].count){
                        var counts_db = '<div>' + '<br>' + 'Results Returned by the  Twitter API: ' +
                                        tweets[1].added + '&nbsp;' +'Tweets' + '<br>' +
                                        'New tweets stored into the database: ' + tweets[1].added + '<br>' +
                                        'Results returned by the database: ' +  tweets[1].count+ ' ' + ' Tweets' +
                                        '<br>' +
                                        '</div>';
                        $('#db_info').append(counts_db);
                    } else {
                        $('#db_info').append(' Results Returned by the  Twitter API: ' + "  " + tweets[1].added);
                    }


                    _.each(tweets[0],function(tweet) {

                        //for word frequencies
                        var initial_words = tweet.text.replace(/[^a-zA-Z0-9 ]/g, "");
                        var words_parse = initial_words.replace(/httpstc|RT/gi, "");
                        var words = words_parse.split(' ');
                        tweets_A.push(tweet.text);

                        // for most active users
                        var user_pattern = (/\B@[a-z0-9_-]+/gi);
                        var user_mentions= tweet.text.match(user_pattern);
                        _.each(user_mentions,function(users){ //console.log(users)
                            if (typeof userCounts[users] === 'undefined') {
                                userCounts[users] = 1;
                            } else {
                                userCounts[users]++
                            }
                        }); //users each

                        var dateReadable, date;
                        dateReadable = new Date(Date.parse(tweet.created_at));
                        date = dateReadable.toDateString();
                        // var tweetHtml = "<li>" + " <img class='ui avatar image'  src='" + tweet.user.profile_image_url + " '>" + '<br>'
                        //         + "  Author: " + tweet.user.name + '&nbsp;' + "<a title='"+ tweet.user.screen_name+"' href='http://twitter.com/"+ tweet.user.screen_name+"'>" +'@'+ tweet.user.screen_name+ "</a>"+ '&nbsp;'+ '\t\t' + '&nbsp;' + ' Date: ' + date + '<br> '
                        //         + "  Tweet: " + tweet.htmlContent +
                        //         (tweet.retweeted_status ? "<br>  Retweet: " +'@'+ tweet.retweeted_status.user.screen_name : "") + '<div class="ui divider">'+ "</li>";
                        var tweetHtml = '<div class="ui list">' + '<div class="item">' +
                                        " <img class='ui avatar image'  src='" + tweet.user.profile_image_url + " '>" +
                                        '<div class="content">' + '<div class="header">' + "Author: " + tweet.user.name + '&nbsp;' +"<a title='"+ tweet.user.screen_name+"' href='http://twitter.com/" + tweet.user.screen_name+"'>" +'@'+ tweet.user.screen_name+ "</a>"+
                                            '&nbsp;'+ '\t\t' + '&nbsp;' + '</div>' + '<span class="date cen">' + ' Date: ' + date +  '</span>' + '<br>'+ '<br>'  + '<div class="description">' + "  Tweet: " + tweet.htmlContent +
                                (tweet.retweeted_status ? "<br>  Retweet: " +'@'+
                                tweet.retweeted_status.user.screen_name : "") +
                                '<div class="ui divider">'+ '</div>' + '</div>' + '</div>';
                        $('#result').append(tweetHtml); // sends the tweet object to the browser
                        $('#most_frequent_words').remove();
                        // maps
                        tweetHTMLArray.push(tweetHtml);
                        if (tweet.geo != null ) {
                            var tweet_lat = tweet.geo.coordinates[0];
                            var tweet_long = tweet.geo.coordinates[1];
                            longCoordinates.push(tweet_long);
                            latCoordinates.push(tweet_lat);
                        }

                        _.each(words, function (word) {

                            if (flaggedWords.indexOf(word) === -1 && word != '') {
                                if (typeof wordCounts[word] === 'undefined') {
                                    wordCounts[word] = 1;
                                } else {
                                    wordCounts[word]++
                                }
                            }

                        }); // words each

                    }); //Tweet Each

                    for( var word in wordCounts){
                        mostUsedWords.push({word: word, count: wordCounts[word]});
                    }

                    for (var user in userCounts){
                        mostActiveUsers.push({user: user, seen: userCounts[user]})
                    }

                    mostActiveUsers.sort(function(a, b) { return b.seen - a.seen;});

                    $('#counts').html('');
                    for(var i= 0; i< 10; i++){
                        if (mostActiveUsers[i]){
                            $('#counts').append('<div id="most_active_users" class="">' +
                                    "<a title='" + mostActiveUsers[i].user + "' href='http://twitter.com/" +
                                    mostActiveUsers[i].user + "'>" + mostActiveUsers[i].user + '&nbsp;' +
                                    "</a>" +' (' + mostActiveUsers[i].seen + ')');
                        }
                    }

                    var finalArray = [];

                    mostUsedWords.sort(function(a, b){ return b.count - a.count;});
                    // $('#counts').append("<div id='head_words'>  " + 'Most Frequent Words: ' + " </div>");
                    // for(var i= 0; i< 20; i++){
                    //     if (mostUsedWords[i]) {
                    //           console.info(mostUsedWords[i]);
                    //          $('#counts').append('<div id="most_frequent_words">' + ' ' + "&nbsp;&nbsp;&nbsp;" + mostUsedWords[i].word  + ':'+ '&nbsp;&nbsp;'+'(' + mostUsedWords[i].count + ") " + " </div>");
                    //     }
                    // }


                    function activeUserAndKeywords(tweets_A, mostActiveUsers, mostUsedWords){
                        var tweet_counter = 0;  //for counting the tweets user is found in
                        var word_counter = 0; //for counting the words in the tweets

                        _.each(mostActiveUsers, function (user) {
                        var temp_tweetCounter =0;
                        var activeUser = new RegExp(user.user);
                            var temp_info = {
                                author: {
                                    screen_name: user.user,
                                    temp_tweetSeen : user.seen,
                                    words : []
                                }
                            };

                            _.each(tweets_A, function(tweet) {
                                if (activeUser.test(tweet)) {
                                    tweet_counter++;
                                    temp_tweetCounter++;

                                    var temp_wordCount =0;
                                    _.each(mostUsedWords, function(word) {
                                        temp_wordCount++;
                                        if(temp_wordCount >=10)
                                            return;
                                        if (tweet.indexOf(word.word) >= 0){
                                            word_counter++;
                                            temp_info.author.words.push({word : word.word , count : word.count});
                                        } else{
                                            return word.word + " is NOT in tweet.";
                                        }
                                    });
                                } else {
                                    return user.user + " is NOT in tweet.";
                                }
                            });
                            temp_info.author.tweet_counts = temp_tweetCounter;
                            finalArray.push({ user : user.user,
                                data: temp_info});
                        });

                    }
                    activeUserAndKeywords(tweets_A, mostActiveUsers, mostUsedWords);

                    $('#count_result').append("<div id='head_words' class='ui blue cen header'>" + "<h4>" + 'Active Users and Words: ' + '</h4>' + "</div>");
                    for(var i= 0; i< 10; i++){
                        if (finalArray[i]) {
                            $('#count_result').append("<div>" + " <img class='ui avatar image'  src='https://twitter.com/" + finalArray[i].data.author.screen_name + "/profile_image?size=original'>" + '&nbsp;' + 'Author: ' + ' ' + "<a title='" + finalArray[i].data.author.screen_name + "' href='http://twitter.com/" + finalArray[i].data.author.screen_name + "'>" + finalArray[i].data.author.screen_name + "</a>" + '&nbsp;&nbsp;  ' + '  ' + '  ' + 'Tweets: ' + finalArray[i].data.author.tweet_counts +'&nbsp;' + "<div class='ui blue cen'>" + "<h5>" + 'Most Frequent Words:' + '</h5>' + '<div class="ui fitted divider">'+ '</div>' + "</div>");

                           var sortedArray =  _.sortBy(_.uniqBy(finalArray[i].data.author.words, 'word'), ['count', 'word']);
                            _.eachRight(_.take(sortedArray,10), function (word) {
                                $('#count_result').append('<div>' + word.word + '&nbsp;' + '  ' + '(' + word.count + ')'+" </div>");
                                 });
                            $('#count_result').append('<div class="ui divider"></div>');
                        }

                    }

                    /* Geo-location map*/
                    function initialize() {
                        var mapCentre = new google.maps.LatLng(latCoordinates[0], longCoordinates[0]);
                        var mapOptions = {
                            zoom: 18,
                            center: mapCentre            };
                        var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
                        for (var i=0; i<longCoordinates.length; i++) {
                            var marker = new google.maps.Marker({
                                position: new google.maps.LatLng(latCoordinates[i], longCoordinates[i]),
                                map: map,
                                title: 'Tweet Marker'});
                            var infowindow = new google.maps.InfoWindow({
                                content: tweetHTMLArray[i]+latCoordinates[i]+', '+longCoordinates[i],
                                maxWidth:200});
                            infowindow.open(map,marker);
                            google.maps.event.addListener(marker, 'click', function() {
                                infowindow.open(map, marker);
                            });
                        }
                    }
                    if (latCoordinates.length > 0) {
                        initialize();
                    }
                    else {
                        $('.gm-style').remove();
                        $('#no_locations').remove();
                        $('#map-canvas').append("<h4 id='no_locations'> <br>Your search returned no geo-located tweets :( try again next time :) <\/h4>");
                    }

                },
                error: function(xhr, status, error) {
                    scrollToContent();
                    console.log('Error: ' + error.message);
                    $('#result').append('<li>' + 'Something went wrong sorry.' + '</li>'); // error output on webpage
                    //alert('error connecting');
                }
            });

        }
        $.fn.serializeObject = function() {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        function sendData() {
            $('#most_active_users').html('');
            $('#most_frequent_words').html('');
            $('#count_result').html('');
            $('#db_info').html('');
            var form = document.getElementById('myForm');
            sendAjaxQuery('http://localhost:3000/', JSON.stringify($('form').serializeObject()));
        }
        var sendButton = document.getElementById('sendButton');
        sendButton.onclick = sendData;
    </script>
<footer>
    <div class="copyright">
            <p>2015 Leonrd & Hayford All rights reserved </p>
    </div>
</footer>
<script>
    $('select.dropdown').dropdown();
    $('.ui.checkbox').checkbox();
    $('.ui.form').form({fields:
                        {
                        playerName: {
                        identifier : 'playerName',
                        optional   : true,
                        rules: [
                            {
                                type   : 'regExp[/@[a-z0-9_-]+/gi]',
                                prompt : 'Please enter a valid player  screen name.'
                            },
                            {
                                type   : 'empty',
                                prompt : 'Please enter a Player name.'
                            },
                            ]
                        },
                            teamName: {
                                identifier : 'teamName',
                                rules: [
                                    {
                                        type   : 'empty',
                                        prompt : 'Please enter a Team or Player name.'
                                    },
                                    {
                                        type   : 'regExp[/@[a-z0-9_-]+/gi]',
                                        prompt : 'Please enter a valid team screen name. - [@name]'
                                    }
                                ]
                            },
                            Hashtags: {
                                identifier : 'hashtag',
                                optional : true,
                                rules: [
                                    {
                                        type   : 'regExp[/#[a-z0-9_-]+/gi]',
                                        prompt : 'Please enter a valid Hashtag. - [#name]'
                                    }
                                ]
                            }

                }
    });
    $('.message .close')
            .on('click', function() {
                $(this).closest('.message').transition('fade');
            });
</script>
<script src="main.js"></script>
</div>
</body>
</html>