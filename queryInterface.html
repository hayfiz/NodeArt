<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>NodeArt</title>
  <link rel="stylesheet" type="text/css" href="/semantic/dist/semantic.min.css">
  <script src="/semantic/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/semantic/dist/semantic.min.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>
  <script src="/node_modules/lodash/lodash.min.js" type="text/javascript"></script>
</head>

<body>
  <div class="ui container">
    <h1 class="ui header">
      <span class="ui image"><i class="feed icon"></i></span>
        <div class="content">
          Twitter Scrapper
        </div>
    </h1>
    <h2 class="ui dividing header">Query some Twitter data</h2>
    <form class="ui form" id="myForm" onsubmit="return false;">
      <input type="radio" name="Or" value="No"> AND
      <br>
      <input type="radio" name="Or" value="YES"> OR
      <br>
      <div class="field">
        <label for="teamName"> Enter the @ of a team you would like to search for:</label>
        <input type="text" name="teamName" placeholder="@ManUtd">
        <br>
        <br>
        <div class="ui-checkbox">
          <input type="checkbox" name="TeamAut" value="YES">
          <label> Author</label>
        </div>
        <div class="ui-checkbox">
          <input type="checkbox" name="TeamMen" value="YES">
          <label> Mentions</label>
        </div>
      </div>
      <div class="field">
        <label for="playerName">Enter the @ of a player you'd like to find:</label>
        <input type="text" name="playerName" placeholder="@WayneRooney">
        <br>
        <br>
        <div class="ui-checkbox">
          <input type="checkbox" name="PlayerAut" value="YES">
          <label> Author</label>
        </div>
        <div class="ui-checkbox">
          <input type="checkbox" name="PlayerMen" value="YES">
          <label> Mentions</label>
        </div>
      </div>
      <div class="field">
        <label for="hashtag">Enter any related hashtags:</label>
        <input type="text" name="hashtag" placeholder="#Research">
      </div>
      <div class="field">
        <label for="keywords">Enter any specific keywords:</label>
        <input type="text" name="keywords" placeholder=" ">
      </div>
      <button class="ui button" id="sendButton">Query Data</button>
    </form>
    <br>
    <div class="ui fluid card">
      <div class="content">
        <div class="header">Tweets Timeline</div>
        <div id="counts">

        </div>
        <ul id="result">

        </ul>
      </div>
      <!-- for now lets make it simple -->
    </div>

  </div>

  <script>
      function sendAjaxQuery(url, data) {
          $('#result').html('');
          $.ajax({
              type: 'POST',
              url: 'postFile.html',
              dataType: 'json',
              data: data,
              success: function(tweets) {
                  //alert('success ' + data);
                  //var struct = JSON.parse(data); //converting to object again
                  var wordCounts = [];
                  _.each(tweets,function(tweet){
                  var date = new Date(tweet.created_at);
                  var initial_words = tweet.text.replace(/[^a-zA-Z0-9 ]/g, "");
                  var words_parse = initial_words.replace(/httpstc|RT/gi, "");
                  var words = words_parse.split(' ');

                  _.each(words,function(word) {
                    var foundWord = _.find(wordCounts, {word: word});
                    if (foundWord) {
                    if (word !== "" && word !== undefined)
                        foundWord.count += 1;
                    } else {  // no word found
                        wordCounts.push({word: word, count: 1});
                    }

                  });


                  var tweetHtml = "<li>" + " <img class='ui avatar image'  src='" + tweet.user.profile_image_url + " '>" + '<br>'
                                  +  "  Author: " + tweet.user.name + ' @' + tweet.user.screen_name + ' Date: ' + moment(date).format("hh:mm ddd DD MMM YYYY") + '<br> '
                                  + "  Tweet: " + tweet.htmlContent + //tweet.text - replace when you get an undefined error. and for server 1
                                  (tweet.retweeted_status ? "<br>  Retweet: " + tweet.retweeted_status.user.screen_name : "") + "</li>";
                          $('#result').append(tweetHtml); // sends the tweet object to the browser

                        });

                  var counted;
                  var sortedWordCounts = _.sortBy(wordCounts,function(word){ return _.take(word.count); });
                  counted = _.take(sortedWordCounts,21);
                  console.log(counted.sort(function (a,b) { var sorted_count = b.count - a.count
                    return sorted_count;
                    }));
                    $('#counts').append('<div>'+ "Most Frequent Words: " + JSON.stringify(counted,null, 4) + '</div>');
                    },

              error: function(xhr, status, error) {
                  console.log('Error: ' + error.message);
                  $('#result').append('<li>' + 'Something went wrong sorry.' + '</li>'); // error output on webpage
                  //alert('error connecting');
              }

          });

      }
      $.fn.serializeObject = function() {
          var o = {};
          var a = this.serializeArray();
          $.each(a, function() {
              if (o[this.name] !== undefined) {
                  if (!o[this.name].push) {
                      o[this.name] = [o[this.name]];
                  }
                  o[this.name].push(this.value || '');
              } else {
                  o[this.name] = this.value || '';
              }
          });
          return o;
      };
      function sendData() {
          var form = document.getElementById('myForm');
          sendAjaxQuery('http://localhost:3000/', JSON.stringify($('form').serializeObject()));
      }
      var sendButton = document.getElementById('sendButton');
      sendButton.onclick = sendData;
  </script>


<script>
  $('.ui.form')
    .form({
      fields: {
        teamName: 'empty',
        playerName : 'empty'

    }
});
</script>

</body>
<!-- + " <img class='"ui avatar image"' src=' "+ tweet.user.profile_image_url + "'>" -->
<!--- tweet.htmlContent -->

</html>
